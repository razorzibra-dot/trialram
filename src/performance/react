/**
 * Phase 9: Performance Optimization Implementation
 * React Query configuration for optimal caching
 */

import { QueryClient } from '@tanstack/react-query';

// Optimized React Query configuration for Phase 9
export const createOptimizedQueryClient = () => {
  return new QueryClient({
    defaultOptions: {
      queries: {
        // Cache configuration for optimal performance
        staleTime: 5 * 60 * 1000, // 5 minutes
        cacheTime: 10 * 60 * 1000, // 10 minutes
        retry: 3,
        retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
        
        // Performance optimizations
        refetchOnWindowFocus: false, // Prevent unnecessary refetches
        refetchOnReconnect: true, // Refetch when coming back online
        refetchOnMount: 'always', // Always refetch on component mount
        
        // Network mode for offline support
        networkMode: 'online',
        
        // Background refetching
        refetchInterval: false, // Disable automatic refetching
        refetchIntervalInBackground: false,
      },
      
      mutations: {
        retry: 1,
        networkMode: 'online',
      },
    },
  });
};

// Optimized cache keys structure
export const cacheKeys = {
  // Customer-related keys
  customers: {
    all: ['customers'] as const,
    lists: () => [...cacheKeys.customers.all, 'list'] as const,
    list: (filters?: Record<string, any>) => [...cacheKeys.customers.lists(), filters] as const,
    details: () => [...cacheKeys.customers.all, 'detail'] as const,
    detail: (id: string) => [...cacheKeys.customers.details(), id] as const,
    stats: (id: string) => [...cacheKeys.customers.detail(id), 'stats'] as const,
    deals: (id: string) => [...cacheKeys.customers.detail(id), 'deals'] as const,
    tickets: (id: string) => [...cacheKeys.customers.detail(id), 'tickets'] as const,
  },

  // Sales-related keys
  deals: {
    all: ['deals'] as const,
    lists: () => [...cacheKeys.deals.all, 'list'] as const,
    list: (filters?: Record<string, any>) => [...cacheKeys.deals.lists(), filters] as const,
    details: () => [...cacheKeys.deals.all, 'detail'] as const,
    detail: (id: string) => [...cacheKeys.deals.details(), id] as const,
    pipeline: () => [...cacheKeys.deals.all, 'pipeline'] as const,
    stats: () => [...cacheKeys.deals.all, 'stats'] as const,
  },

  // User-related keys
  users: {
    all: ['users'] as const,
    lists: () => [...cacheKeys.users.all, 'list'] as const,
    list: (filters?: Record<string, any>) => [...cacheKeys.users.lists(), filters] as const,
    details: () => [...cacheKeys.users.all, 'detail'] as const,
    detail: (id: string) => [...cacheKeys.users.details(), id] as const,
    profile: () => [...cacheKeys.users.all, 'profile'] as const,
    roles: () => [...cacheKeys.users.all, 'roles'] as const,
  },

  // Ticket-related keys
  tickets: {
    all: ['tickets'] as const,
    lists: () => [...cacheKeys.tickets.all, 'list'] as const,
    list: (filters?: Record<string, any>) => [...cacheKeys.tickets.lists(), filters] as const,
    details: () => [...cacheKeys.tickets.all, 'detail'] as const,
    detail: (id: string) => [...cacheKeys.tickets.details(), id] as const,
    comments: (id: string) => [...cacheKeys.tickets.detail(id), 'comments'] as const,
    stats: () => [...cacheKeys.tickets.all, 'stats'] as const,
  },

  // Dashboard and analytics
  dashboard: {
    all: ['dashboard'] as const,
    overview: () => [...cacheKeys.dashboard.all, 'overview'] as const,
    stats: () => [...cacheKeys.dashboard.all, 'stats'] as const,
    activity: () => [...cacheKeys.dashboard.all, 'activity'] as const,
    kpis: () => [...cacheKeys.dashboard.all, 'kpis'] as const,
  },

  // Reference data
  referenceData: {
    all: ['referenceData'] as const,
    categories: () => [...cacheKeys.referenceData.all, 'categories'] as const,
    category: (category: string) => [...cacheKeys.referenceData.categories(), category] as const,
    permissions: () => [...cacheKeys.referenceData.all, 'permissions'] as const,
    roles: () => [...cacheKeys.referenceData.all, 'roles'] as const,
  },

  // System configuration
  config: {
    all: ['config'] as const,
    app: () => [...cacheKeys.config.all, 'app'] as const,
    user: () => [...cacheKeys.config.all, 'user'] as const,
    features: () => [...cacheKeys.config.all, 'features'] as const,
  },
};

// Cache invalidation strategies
export const cacheInvalidation = {
  // When customer data is updated
  onCustomerUpdate: (customerId: string) => [
    ...cacheKeys.customers.detail(customerId).slice(0, -1), // Remove the ID
    'list', // Invalidate all customer lists
    'stats', // Invalidate dashboard stats
  ],

  // When deal data is updated  
  onDealUpdate: (dealId: string) => [
    ...cacheKeys.deals.detail(dealId).slice(0, -1), // Remove the ID
    'list', // Invalidate all deal lists
    'pipeline', // Invalidate pipeline view
    'stats', // Invalidate stats
  ],

  // When user data is updated
  onUserUpdate: (userId: string) => [
    ...cacheKeys.users.detail(userId).slice(0, -1), // Remove the ID
    'list', // Invalidate user lists
    'profile', // Invalidate current user profile
  ],

  // When ticket data is updated
  onTicketUpdate: (ticketId: string) => [
    ...cacheKeys.tickets.detail(ticketId).slice(0, -1), // Remove the ID
    'list', // Invalidate ticket lists
    'stats', // Invalidate stats
  ],

  // Global invalidation for major changes
  onUserRoleChange: () => [
    cacheKeys.referenceData.permissions(),
    cacheKeys.config.user(),
    cacheKeys.dashboard.overview(),
  ],

  onSystemConfigChange: () => [
    cacheKeys.config.app(),
    cacheKeys.config.features(),
    cacheKeys.referenceData.categories(),
  ],
};

// Optimistic updates configuration
export const optimisticUpdates = {
  // Customer updates
  updateCustomer: {
    onMutate: async (variables: any) => {
      const queryClient = getQueryClient();
      
      // Cancel outgoing refetches
      await queryClient.cancelQueries(cacheKeys.customers.detail(variables.id));
      
      // Snapshot previous value
      const previousCustomer = queryClient.getQueryData(cacheKeys.customers.detail(variables.id));
      
      // Optimistically update to the new value
      queryClient.setQueryData(cacheKeys.customers.detail(variables.id), (old: any) => ({
        ...old,
        ...variables.data,
      }));
      
      // Return context for rollback
      return { previousCustomer };
    },
    onError: (err: any, variables: any, context: any) => {
      // Rollback on error
      const queryClient = getQueryClient();
      queryClient.setQueryData(cacheKeys.customers.detail(variables.id), context?.previousCustomer);
    },
    onSettled: (data: any, error: any, variables: any) => {
      // Always refetch after error or success
      const queryClient = getQueryClient();
      queryClient.invalidateQueries(cacheKeys.customers.detail(variables.id));
    },
  },
};

// Query prefetching strategies
export const prefetchStrategies = {
  // Prefetch customer data when hovering over customer link
  prefetchCustomer: (customerId: string) => {
    const queryClient = getQueryClient();
    return queryClient.prefetchQuery({
      queryKey: cacheKeys.customers.detail(customerId),
      queryFn: () => customerService.getCustomer(customerId),
      staleTime: 10 * 60 * 1000, // 10 minutes
    });
  },

  // Prefetch dashboard data when user logs in
  prefetchDashboard: () => {
    const queryClient = getQueryClient();
    const prefetchQueries = [
      cacheKeys.dashboard.overview(),
      cacheKeys.dashboard.stats(),
      cacheKeys.dashboard.kpis(),
    ];

    return Promise.all(
      prefetchQueries.map(queryKey =>
        queryClient.prefetchQuery({
          queryKey,
          queryFn: () => dashboardService.getOverview(),
          staleTime: 5 * 60 * 1000, // 5 minutes
        })
      )
    );
  },
};

// Background sync configuration
export const backgroundSync = {
  enabled: true,
  syncInterval: 30 * 1000, // 30 seconds
  syncStrategies: [
    {
      queryKey: cacheKeys.dashboard.overview(),
      syncFn: () => dashboardService.syncOverview(),
    },
    {
      queryKey: cacheKeys.referenceData.categories(),
      syncFn: () => referenceDataService.refreshCategories(),
    },
  ],
};

// Performance monitoring for queries
export const queryPerformance = {
  trackQueryPerformance: (queryKey: any[], queryFn: () => Promise<any>) => {
    const startTime = performance.now();
    
    return queryFn().finally(() => {
      const endTime = performance.now();
      const duration = endTime - startTime;
      
      // Log slow queries
      if (duration > 1000) {
        console.warn(`Slow query detected: ${JSON.stringify(queryKey)} took ${duration}ms`);
      }
      
      // Send to monitoring service
      if (duration > 500) {
        // Send to performance monitoring service
        performanceMonitor.recordQueryDuration(queryKey, duration);
      }
    });
  },
};

// Global query client instance
let queryClient: QueryClient | null = null;

export const getQueryClient = () => {
  if (!queryClient) {
    queryClient = createOptimizedQueryClient();
  }
  return queryClient;
};

// Performance monitoring service
const performanceMonitor = {
  recordQueryDuration: (queryKey: any[], duration: number) => {
    // Implementation would send metrics to monitoring service
    console.debug(`Query performance: ${JSON.stringify(queryKey)} - ${duration}ms`);
  },
};

// Service imports (would be actual service imports)
const customerService = {
  getCustomer: (id: string) => Promise.resolve({}),
};

const dashboardService = {
  getOverview: () => Promise.resolve({}),
  syncOverview: () => Promise.resolve({}),
};

const referenceDataService = {
  refreshCategories: () => Promise.resolve({}),
};